<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flashing Rectangle and Microphone Recording</title>
    <style>
        #rectangle {
            width: 200px;
            height: 200px;
            margin: 20px;
            background-color: white;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #rectangle::after {
            content: '';
            width: 10px;
            height: 10px;
            background-color: red;
            border-radius: 50%;
        }

        .svgs {
            border: 1px solid #ccc;
        }
    </style>
    <!-- <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script> -->
    <script src="https://cdn.bootcdn.net/ajax/libs/d3/5.9.7/d3.js"></script>
</head>

<body>


    <div>
        <label for="duration">Duration (seconds): </label>
        <input type="number" id="duration" min="1" step="1" value="2">
    </div>
    <div>
        <label for="frequency">Frequency (Hz): </label>
        <input type="number" id="frequency" min="0.1" step="0.1" value="2">
    </div>
    <button id="startButton">Start</button>
    <!-- <button id="stopButton">Stop</button> -->
    <div id="rectangle"></div>

    <svg width="800" height="200" id="waveformSVG" class="svgs"></svg>
    <svg width="800" height="200" id="spectrumSVG" class="svgs"></svg>




    <script async type="text/javascript" src="foo.js"></script> <!-- 异步加载 foo.js 脚本 -->
    <script async type="text/javascript" src="getSolutionImage.js"></script>


    <script>

        let rectangle = document.getElementById('rectangle');
        let durationInput = document.getElementById('duration');
        let frequencyInput = document.getElementById('frequency');
        let startButton = document.getElementById('startButton');
        // let stopButton = document.getElementById('stopButton');
        let waveformSVG = d3.select("#waveformSVG");
        let spectrumSVG = d3.select("#spectrumSVG");
        let audioContext, mediaRecorder, audioChunks = [];


        function flashRectangle(duration, frequency) {
            let startTime = Date.now();
            function flash() {
                let elapsedTime = (Date.now() - startTime) / 1000;
                let intensity = (Math.cos(2 * Math.PI * frequency * elapsedTime) + 1) / 2 * 255;
                rectangle.style.backgroundColor = `rgb(${intensity}, ${intensity}, ${intensity})`;
                if (elapsedTime < duration) {
                    requestAnimationFrame(flash);
                } else {
                    rectangle.style.backgroundColor = 'white';
                }
            }
            flash();
        }

        function recordAudio() {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };
                mediaRecorder.onstop = analyzeAudio;
                mediaRecorder.start();
            });
        }

        function analyzeAudio() {
            let audioBlob = new Blob(audioChunks);
            let reader = new FileReader();
            reader.readAsArrayBuffer(audioBlob);
            reader.onloadend = () => {
                audioContext.decodeAudioData(reader.result, buffer => {
                    let data = buffer.getChannelData(0);
                    plotWaveform(data, buffer.sampleRate);
                    plotSpectrum(data, buffer.sampleRate);
                });
            };
        }

        function plotWaveform(data, sampleRate) {

            const width = +waveformSVG.attr('width');
            const height = +waveformSVG.attr('height');
            const margin = { top: 20, right: 20, bottom: 30, left: 50 };
            const innerWidth = width - margin.left - margin.right;
            const innerHeight = height - margin.top - margin.bottom;

            const xScale = d3.scaleLinear()
                .domain([0, data.length / sampleRate * 1000]) // Time in milliseconds
                .range([0, innerWidth]);

            const yScale = d3.scaleLinear()
                .domain([Math.min(...data), Math.max(...data)])
                .range([innerHeight, 0]);

            waveformSVG.selectAll('*').remove(); // Clear previous contents

            const g = waveformSVG.append('g')
                .attr('transform', `translate(${margin.left}, ${margin.top})`);

            const xAxis = d3.axisBottom(xScale)
                .tickFormat(d => `${Math.round(d)} ms`);
            g.append('g')
                .call(xAxis)
                .attr('transform', `translate(0, ${innerHeight})`);

            const yAxis = d3.axisLeft(yScale);
            g.append('g')
                .call(yAxis);

            const lineGenerator = d3.line()
                .x((d, i) => xScale(i / sampleRate * 1000)) // Convert sample index to time in milliseconds
                .y(d => yScale(d));

            g.append('path')
                .datum(data)
                .attr('d', lineGenerator)
                .attr('fill', 'none')
                .attr('stroke', 'blue')
                .attr('stroke-width', 1);

            g.append('text')
                .text('Waveform')
                .attr('font-size', '1em')
                .attr('transform', `translate(${innerWidth / 2}, ${innerHeight + 40})`)
                .attr('text-anchor', 'middle');


        }

        function plotSpectrum(data, sampleRate) {
            let duration = parseFloat(durationInput.value);
            let fftSize = Math.pow(2, Math.ceil(Math.log2(data.length)));

            let data_ = data.subarray(0, 48000*duration);
            // data_[data_.length]=48000*duration;

            // let length = Math.ceil(data_.length / 48);
            // let sampledData = new Float32Array(length);

            // for (let i = 0; i < length; i++) {
            //     sampledData[i] = data_[i * interval];
            // }


            let data_out_all = getSolImage(data_);

            let n = 100;

            let data_out = data_out_all.slice(0, n * 2);

            let frequency = data_out.slice(0, n); // 频率
            let magnitude = data_out.slice(n, n * 2); // PSD
            //////////////////////////////////////////////////////////////////////////////////////////

            // 自适应刻度
            const width = +spectrumSVG.attr('width');
            const height = +spectrumSVG.attr('height');
            const margin = { top: 20, right: 20, bottom: 30, left: 50 };
            const innerWidth = width - margin.left - margin.right;
            const innerHeight = height - margin.top - margin.bottom;

            const xScale = d3.scaleLinear()
                .domain([Math.min(...frequency), Math.max(...frequency)]) // 从 0 到最大频率
                .range([0, innerWidth]);

            const yScale = d3.scaleLinear()
                .domain([0, Math.max(...magnitude)]) // 从 0 到最大 PSD
                .range([innerHeight, 0]);

            spectrumSVG.selectAll('*').remove(); // 清除旧内容

            const g = spectrumSVG.append('g')
                .attr('transform', `translate(${margin.left}, ${margin.top})`);

            const xAxis = d3.axisBottom(xScale)
                .tickFormat(d => `${Math.round(d)} Hz`);

            g.append('g')
                .call(xAxis)
                .attr('transform', `translate(0, ${innerHeight})`);

            const yAxis = d3.axisLeft(yScale);
            g.append('g')
                .call(yAxis);

            const lineGenerator = d3.line()
                .x(d => xScale(d.x))
                .y(d => yScale(d.y));

            const lineData = frequency.map((freq, i) => ({ x: freq, y: magnitude[i] }));

            g.append('path')
                .datum(lineData)
                .attr('d', lineGenerator)
                .attr('fill', 'none')
                .attr('stroke', 'blue')
                .attr('stroke-width', 1);

            g.append('text')
                .text('Spectrum')
                .attr('font-size', '1em')
                .attr('transform', `translate(${innerWidth / 2}, ${innerHeight + 40})`)
                .attr('text-anchor', 'middle');
        }


        startButton.addEventListener('click', () => {
            audioChunks = [];
            let duration = parseFloat(durationInput.value);
            let frequency = parseFloat(frequencyInput.value);
            recordAudio();
            flashRectangle(duration, frequency);
            setTimeout(() => {
                mediaRecorder.stop();
            }, (duration + 0.1) * 1000);
        });

        // stopButton.addEventListener('click', () => {
        //     mediaRecorder.stop();
        // });
    </script>
</body>

</html>