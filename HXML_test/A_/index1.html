<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Passing Data</title>
</head>
<body>
    <script async type="text/javascript" src="foo.js"></script> <!-- 异步加载 foo.js 脚本 -->
    <script>
        function _arrayToHeap(typedArray) {
            var numBytes = typedArray.length * typedArray.BYTES_PER_ELEMENT;  // 计算数组所需的字节数
            var ptr = Module._malloc(numBytes);  // 分配内存
            var heapBytes = new Uint8Array(Module.HEAPU8.buffer, ptr, numBytes);  // 创建与内存块关联的Uint8Array
            heapBytes.set(new Uint8Array(typedArray.buffer));  // 将数据复制到heapBytes
            return heapBytes;
        }

        function _heapToArray(heapBytes, array) {
            return new Float64Array(
                heapBytes.buffer,
                heapBytes.byteOffset,
                heapBytes.length / array.BYTES_PER_ELEMENT
            );  // 从Heap内存转换回TypedArray
        }

        function _freeArray(heapBytes) {
            Module._free(heapBytes.byteOffset);  // 释放之前分配的内存
        }

        var Module = {
            onRuntimeInitialized: function () {
                var a = [1, 2, 3, 4,5,6,7];
                var b = [3, 4, 5, 6,7,8,9];

                var A = new Float64Array(a);  // 将普通数组转换为TypedArray
                var B = new Float64Array(b);
                var C = new Float64Array(80);  // 预先分配结果数组

                var Abytes = _arrayToHeap(A);  // 转换为Heap内存
                var Bbytes = _arrayToHeap(B);
                var Cbytes = _arrayToHeap(C);

                Module._foo_initialize();  // 初始化WebAssembly模块
                Module._foo(Abytes.byteOffset, Bbytes.byteOffset, Cbytes.byteOffset);  // 调用WebAssembly函数
                Module._foo_terminate();  // 终止WebAssembly模块

                C = _heapToArray(Cbytes, C);  // 从Heap内存中获取结果
                var c = Array.from(C);  // 转换回普通数组

                _freeArray(Abytes);  // 释放内存
                _freeArray(Bbytes);
                _freeArray(Cbytes);

                console.log(a + " + " + b + " = " + c);  // 打印结果
            }
        };
    </script>
</body>
</html>
